name: release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: 'false'
  workflow_run:
    workflows: [nightly]
    types: [completed]

permissions:
  contents: write

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide source (nightly run)
        id: src
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
            echo "mode=from_trigger" >> $GITHUB_OUTPUT
          else
            echo "run_id=" >> $GITHUB_OUTPUT
            echo "mode=latest_success" >> $GITHUB_OUTPUT
          fi

      - name: Download artifacts from nightly (triggered run)
        if: ${{ steps.src.outputs.mode == 'from_trigger' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ steps.src.outputs.run_id }}
          name: "*"
          path: artifacts

      - name: Download artifacts from latest successful nightly
        if: ${{ steps.src.outputs.mode == 'latest_success' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: nightly
          workflow_conclusion: success
          branch: main
          name: "*"
          path: artifacts

      - name: List artifacts
        run: |
          ls -R artifacts || true

      - name: Zip artifacts for release
        run: |
          set -e
          mkdir -p release
          if [ -d artifacts/dashboards ]; then (cd artifacts && zip -r ../release/dashboards-us.zip dashboards); fi
          if [ -d artifacts/dashboards-kr ]; then (cd artifacts && zip -r ../release/dashboards-kr.zip dashboards-kr); fi
          if [ -d artifacts/outputs-us ]; then (cd artifacts && zip -r ../release/outputs-us.zip outputs-us); fi
          if [ -d artifacts/outputs-kr ]; then (cd artifacts && zip -r ../release/outputs-kr.zip outputs-kr); fi

      - name: Compute tag
        id: tag
        run: |
          echo "TAG=release-$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
          echo "NAME=Release $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.NAME }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
