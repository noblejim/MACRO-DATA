name: nightly

on:
  schedule:
    - cron: "0 17 * * *" # 02:00 KST
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: nightly
  cancel-in-progress: false

jobs:
  build-us:
    runs-on: ubuntu-latest
    timeout-minutes: 75
    env:
      FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
      FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      TZ: Asia/Seoul
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install -q pandas numpy xlsxwriter finance-datareader openpyxl
      - name: Restore caches (US)
        uses: actions/cache@v4
        with:
          path: |
            data/us/.cache_fred
            data/us/.cache_fmp
          key: cache-us-${{ runner.os }}-${{ hashFiles('scripts/**/*.py','data/us/macro_sources.csv') }}
          restore-keys: |
            cache-us-${{ runner.os }}-
      - name: Prepare folders
        run: |
          mkdir -p out/us/logs dashboards
      - name: Seed/Backfill events (FRED)
        run: |
          python scripts/backfill_events_from_fred.py --data-dir data/us --all-fred --start 2000-01-01 --fred-key "$FRED_API_KEY" || true
      - name: Fetch prices (FMP with FDR fallback)
        run: |
          python scripts/fetch_prices_fmp.py --data-dir data/us --start 2000-01-01 --slice-years
      - name: Fill US macro actuals (FRED)
        run: |
          python scripts/fetch_macro_from_fred.py --data-dir data/us --fred-key "$FRED_API_KEY"
      - name: Merge macro actuals
        run: |
          python scripts/merge_macro_actuals.py --data-dir data/us --backup
      - name: Build reaction matrices
        run: |
          python scripts/build_reaction_matrix.py --market us --data-dir data/us --out-dir out/us --sector-benchmark-csv data/us/sector_benchmarks.csv --write-wide --win1 1 --win3 3 --compute-cycles --cycle-windows 21,63,126 --regimes-csv data/us/macro_regimes.csv
      - name: Join cycles into reaction_with_cycle (US)
        run: |
          python scripts/join_cycles_into_reactions.py --market us --out-dir out/us --windows 21,63,126
      - name: Additional windows (±5/±10/±21)
        run: |
          python scripts/compute_additional_windows.py --market us --data-dir data/us --out-dir out/us --windows 5,10,21
      - name: Macro impact + quantile + partial + focus
        run: |
          python scripts/compute_macro_impact.py --market us --out-dir out/us
          python scripts/compute_reaction_by_surprise_quantile.py --market us --out-dir out/us --last-days 180 --last-events 100
          python scripts/compute_partial_impact.py --market us --out-dir out/us --by-regime
          python scripts/analyze_focus_events.py --market us --out-dir out/us --last-days 180 --last-events 100 --regime-current
      - name: Build dashboard (advanced)
        run: |
          python scripts/build_excel_dashboard_plus.py --market us --data-dir data/us --out-dir out/us --last-days 365 --last-events 180 --dashboard-path dashboards/us_dashboard.xlsx
      - name: Add Overview hyperlinks (US)
        run: |
          python scripts/postprocess_add_overview_links.py --dashboard-path dashboards/us_dashboard.xlsx
      - name: Upload dashboards
        uses: actions/upload-artifact@v4
        with:
          name: dashboards
          path: dashboards/us_dashboard.xlsx
          if-no-files-found: ignore
          retention-days: 14
      - name: Upload outputs (CSV + logs)
        uses: actions/upload-artifact@v4
        with:
          name: outputs-us
          path: |
            out/us/**
          if-no-files-found: ignore
          retention-days: 14

  build-kr:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: build-us
    env:
      BOK_API_KEY:  ${{ secrets.BOK_API_KEY }}
      KOSIS_API_KEY: ${{ secrets.KOSIS_API_KEY }}
      TZ: Asia/Seoul
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install -q pandas numpy xlsxwriter finance-datareader openpyxl
      - name: Prepare folders
        run: |
          mkdir -p out/kr/logs dashboards
      - name: Seed KR macro events (36m)
        run: |
          python scripts/seed_events_from_links.py --data-dir data/kr --months 36
      - name: Fetch KR prices (FDR)
        run: |
          python scripts/fetch_prices_fdr.py --data-dir data/kr --start 2000-01-01
      - name: Fetch KR macro actuals (BOK/KOSIS)
        run: |
          python scripts/fetch_macro_from_bok_kosis.py --data-dir data/kr || true
      - name: Merge KR macro actuals
        run: |
          python scripts/merge_macro_actuals.py --data-dir data/kr --backup
      - name: Build reaction matrices (KR)
        run: |
          python scripts/build_reaction_matrix.py --market kr --data-dir data/kr --out-dir out/kr --sector-benchmark-csv data/kr/sector_benchmarks.csv --write-wide --win1 1 --win3 3 --compute-cycles --cycle-windows 21,63,126 --regimes-csv data/kr/macro_regimes.csv
      - name: Join cycles into reaction_with_cycle (KR)
        run: |
          python scripts/join_cycles_into_reactions.py --market kr --out-dir out/kr --windows 21,63,126
      - name: Additional windows (KR)
        run: |
          python scripts/compute_additional_windows.py --market kr --data-dir data/kr --out-dir out/kr --windows 5,10,21
      - name: Macro impact + quantile + partial + focus (KR)
        run: |
          python scripts/compute_macro_impact.py --market kr --out-dir out/kr || true
          python scripts/compute_reaction_by_surprise_quantile.py --market kr --out-dir out/kr --last-days 180 --last-events 100 || true
          python scripts/compute_partial_impact.py --market kr --out-dir out/kr --by-regime || true
          python scripts/analyze_focus_events.py --market kr --out-dir out/kr --last-days 180 --last-events 100 --regime-current || true
      - name: Build dashboard (advanced KR)
        run: |
          python scripts/build_excel_dashboard_plus.py --market kr --data-dir data/kr --out-dir out/kr --last-days 365 --last-events 180 --dashboard-path dashboards/kr_dashboard.xlsx
      - name: Add Overview hyperlinks (KR)
        run: |
          python scripts/postprocess_add_overview_links.py --dashboard-path dashboards/kr_dashboard.xlsx
      - name: Upload dashboards (KR)
        uses: actions/upload-artifact@v4
        with:
          name: dashboards-kr
          path: dashboards/kr_dashboard.xlsx
          if-no-files-found: ignore
          retention-days: 14
      - name: Upload outputs (KR)
        uses: actions/upload-artifact@v4
        with:
          name: outputs-kr
          path: |
            out/kr/**
          if-no-files-found: ignore
          retention-days: 14
